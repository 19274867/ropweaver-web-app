<!-- report.html -->
<!DOCTYPE HTML>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Free Online ROP Gadgets Search</title>
<link rel="stylesheet" href="css/pure-min.css" />
<link rel="stylesheet" href="css/skin-mine.css" />
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDZ3BEfUstg32hqnbctG7X3LQ5onNJ98qs",
    authDomain: "ropweaver.firebaseapp.com",
    projectId: "ropweaver",
    storageBucket: "ropweaver.appspot.com",
    messagingSenderId: "356547989098",
    appId: "1:356547989098:web:16a48b40d0bde270df8413",
    measurementId: "G-CR1P508GPH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.onload = async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const reportId = urlParams.get('id');
    const pre = document.getElementById("report-body");

    if (!reportId) {
      pre.innerText = "Error: No report ID provided in URL.";
      return;
    }

    try {
      const q = query(collection(db, "gadgets"), where("report_id", "==", reportId));
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        pre.innerText = `ropweaver> No gadgets found for ${reportId}`;
        return;
      }

      let gadgets = [];
      snapshot.forEach(doc => gadgets.push(doc.data()));

      const fileName = gadgets[0]["file name"] || "unknown";
      const arch = gadgets[0].architecture || "unknown";
      const category = gadgets[0].category || "unknown";
      const baseAddress = gadgets[0].address || "0x0";

      // let output = `ropweaver> use <a href="search?h=${reportId}">${reportId}</a> (<a href="#">download</a>)\n`;
      let output = `ropweaver> use <a href="search?h=${reportId}">${reportId}</a> (<a href="#" onclick="downloadReport('${reportId}')">download</a>)\n`;
      output += `name         : ${fileName} (${arch}/${category})\n`;
      output += `base address : ${baseAddress}\n`;
      output += `total gadgets: ${gadgets.length}\n\n`;

      // Grouping ROPGadgets in sequence 
      const instructionsMap = new Map();
      for (const g of gadgets) {
        const key = g.instructions.split(';')[0].split(' ')[0];
        if (!instructionsMap.has(key)) instructionsMap.set(key, []);
        instructionsMap.get(key).push(g);
      }

      output += `ropweaver> suggest\n`;
      instructionsMap.forEach((list, keyword) => {
        output += `<a href="ropsearch?h=${reportId}&s=${encodeURIComponent(keyword)}">${keyword}</a>\n`;
        list.slice(0, 5).forEach(g => {
          output += `    > ${g.address} : ${g.instructions}\n`;
        });
      });

      pre.innerHTML = output;
    } catch (err) {
      pre.innerText = `ropweaver> Error fetching report: ${err.message}`;
    }
  };
</script>
</head>
<body class="pure-skin-mine">
<div class="pure-g">
    <div class="pure-u-1-24"></div>
    <div class="pure-u-22-24">
        <div class="pure-menu pure-menu-open pure-menu-horizontal">
            <a href="index.html" class="pure-menu-heading">ROPWeaver</a>
            <ul>
                <li><a href="upload.html">Upload</a></li>
                <li><a href="search.html">Search</a></li>
                <li><a href="howto.html">Howto</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </div>

        <div class="content">
            <pre id="report-body">
ropweaver> loading...
            </pre>
        </div>

        <div class="footer l-box is-center">
            <p class="copyright">
            &copy; 2025 - Powered by <a href="index.html">ROPWeaver</a> | <a href="mailto:admin@ropweaver.com">Contact</a>
            </p>
        </div>
    </div>
</div>
</body>
<script>
  function downloadReport(reportId) {
    // Download report.txt
    const reportText = `Report ID: ${reportId}
	Generated by ROPWeaver

	name         : ${fileName} (${arch}/${category})
	base address : ${baseAddress}
	total gadgets: ${gadgets.length}
	
	`;

    const blob = new Blob([reportText], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${reportId}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>
</html>
